name: Build Test

on:
  workflow_dispatch:
  pull_request:
    branches: [main, beta]

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-musl
            artifact_name: stakpak-linux-aarch64
            features: --features jemalloc
            docker: rust:1.91-alpine3.21

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # Alpine Linux is musl-native â€” GCC has full C11 atomics support
      # without the broken musl-gcc wrapper that Ubuntu's musl-tools uses.
      - name: Build and test in Alpine container
        if: matrix.docker
        uses: addnab/docker-run-action@v3
        with:
          image: ${{ matrix.docker }}
          options: >-
            --user 0:0
            -v ${{ github.workspace }}:/build
            -w /build
          run: |
            apk add --no-cache gcc musl-dev
            cargo build --release --target ${{ matrix.target }} ${{ matrix.features }}
            cargo test --target ${{ matrix.target }}
